@page "/Login"
@using BestMovies.Services.implementation
@using BestMovies.Pages.util
@namespace LoginComponent

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<AuthorizeView>
    <NotAuthorized>
        <MudPaper>
            <MudText Align="Align.Center">Login</MudText>
            <MudStack>
                <MudTextField T="string" @bind-value="_username" Placeholder="Username" Immediate="true" Variant="Variant.Filled" Margin="Margin.Dense" OnKeyDown="AttemptLogin"/>
                <MudSpacer/>
                <MudTextField T="string" @bind-value="_password" Placeholder="Password" Immediate="true" Variant="Variant.Filled" Margin="Margin.Dense" InputType="InputType.Password" OnKeyDown="AttemptLogin"/>
            </MudStack>
        </MudPaper>
    </NotAuthorized>
    <Authorized>
        
    </Authorized>
</AuthorizeView>

@code {
    private string _username;
    private string _password;
    private string _errorMessage;

    public void AttemptLogin(KeyboardEventArgs e)
    {
    // If the User has pressed Enter, attempt a login
        if (e.Key == "Enter")
        {
            Console.WriteLine($"User: {_username} - Pass: {_password}");
            PerformLogin();
        }
    }

    public async Task PerformLogin()
    {
        _errorMessage = "";
        try
        {
            await ((CustomAuthenticationStateProvider)AuthenticationStateProvider).ValidateLogin(_username, PasswordHashing.HashString(_password));
            _username = "";
            _password = "";
            NavigationManager.NavigateTo("/");
        }
        catch (Exception e)
        {
            _errorMessage = e.Message;
            Snackbar.Add(_errorMessage, Severity.Error, key: "LoginError");
        }
    }

    public async Task PerformLogout()
    {
        _errorMessage = "";
        _username = "";
        _password = "";
        try
        {
            ((CustomAuthenticationStateProvider)AuthenticationStateProvider).Logout();
            NavigationManager.NavigateTo("/");
        }
        catch (Exception e)
        {
        }
    }
}