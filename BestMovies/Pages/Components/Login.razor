@page "/Login"
@using BestMovies.Services.implementation
@namespace LoginComponent

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<AuthorizeView>
    <NotAuthorized>
        <MudPaper>
            <MudText Align="Align.Center">Login</MudText>
            <MudStack>
                <MudTextField T="string" @bind-value="_username" Placeholder="Username" Immediate="true" Variant="Variant.Filled" Margin="Margin.Dense" OnKeyDown="AttemptLogin"/>
                <MudSpacer/>
                <MudTextField T="string" @bind-value="_password" Placeholder="Password" Immediate="true" Variant="Variant.Filled" Margin="Margin.Dense" InputType="InputType.Password" OnKeyDown="AttemptLogin"/>
            </MudStack>
        </MudPaper>
    </NotAuthorized>
    <Authorized>
        
    </Authorized>
</AuthorizeView>

@code {
    private string _username;
    private string _password;
    private string _errorMessage;

    public void AttemptLogin(KeyboardEventArgs e)
    {
    // If the User has pressed Enter, attempt a login
        if (e.Key == "Enter")
        {
            Console.WriteLine($"User: {_username} - Pass: {_password}");
            PerformLogin();
        }
    }

    public async Task PerformLogin()
    {
        _errorMessage = "";
        try
        {
            await ((CustomAuthenticationStateProvider)AuthenticationStateProvider).ValidateLogin(_username, HashString(_password, "sep6"));
            _username = "";
            _password = "";
            NavigationManager.NavigateTo("/");
        }
        catch (Exception e)
        {
            _errorMessage = e.Message;
            Snackbar.Add(_errorMessage, Severity.Error, key: "LoginError");
        }
    }

    public async Task PerformLogout()
    {
        _errorMessage = "";
        _username = "";
        _password = "";
        try
        {
            ((CustomAuthenticationStateProvider)AuthenticationStateProvider).Logout();
            NavigationManager.NavigateTo("/");
        }
        catch (Exception e)
        {
        }
    }

    private string HashString(string text, string salt = "")
    {
        if (string.IsNullOrEmpty(text))
        {
            return string.Empty;
        }

        // Uses SHA256 to create the hash
        using (var sha = new System.Security.Cryptography.SHA256Managed())
        {
        // Convert the string to a byte array first, to be processed
            byte[] textBytes = System.Text.Encoding.UTF8.GetBytes(text + salt);
            byte[] hashBytes = sha.ComputeHash(textBytes);

        // Convert back to a string, removing the '-' that BitConverter adds
            string hash = BitConverter
                .ToString(hashBytes)
                .Replace("-", string.Empty);

            return hash;
        }
    }

}